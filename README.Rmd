---
output: rmarkdown::github_document
---

`jwatr` : Tools to Query and Create Web Archive Files Using the Java Web Archive Toolkit

The Java Web Archive Toolkit ('JWAT') <https://sbforge.org/display/JWAT/Overview>
is a library of Java objects and methods which enables reading, writing and validating web 
archive files. Intial support is provided to read 'gzip' compressed 'WARC' files. Future 
plans include support for reading and writing all formats supported by 'JWAT'.

WIP!!! Reading & writing need some optimization and edge case checking. There's also a chance I'll change the name to `warc` but some folks are using that package now and I dinna want to cause pain there yet.

The following functions are implemented:

*Reading*

- `read_warc`:	Read a WARC file

*Writing*

- `warc_file`:	Create a new WARC file
- `warc_write_response`:	Add the response to a HTTP GET request to a WARC file
- `close_warc_file`:	Close a WARC file

NOTE: To read in typical (~800MB-1GB gzip'd WARC files) you should consider doing the following (in order) in your scripts:

```{r eval=FALSE}
options(java.parameters = "-Xmx2g")

library(rJava)
library(jwatjars)
library(jwatr)
```

That idiom generally provides enough heap space, but you may need to adjust the heap size if you've got larger payloads.

Alternatively, you can set the same option in your R startup scripts, but that will likely come back to bite you when moving workloads around.

### Installation

```{r eval=FALSE}
devtools::install_github("hrbrmstr/jwatr")
```

```{r message=FALSE, warning=FALSE, error=FALSE, include=FALSE}
options(width=120)
```

### Reading WARC Files

```{r message=FALSE, warning=FALSE, error=FALSE}
library(rJava)
library(jwatr)
library(magick)
library(tidyverse)

# current verison
packageVersion("jwatr")
```

```{r message=FALSE, warning=FALSE, error=FALSE}
xdf <- read_warc(system.file("extdata/sample.warc.gz", package="jwatr"),
                 warc_types = "response", TRUE)

glimpse(xdf)

imgs <- filter(xdf, grepl("(png|gif|jpeg)$", http_protocol_content_type))

imgs

image_read(imgs$payload[[1]])
```

![](imgs/img1.jpeg)

### Writing WARC Files

```{r message=FALSE, warning=FALSE, error=FALSE}
library(jwatr)
library(magick)
library(htmltools)
library(tidyverse)

wf <- warc_file("~/Desktop/test")
warc_write_response(wf, "https://rud.is/b/")
warc_write_response(wf, "https://www.rstudio.com/")
warc_write_response(wf, "https://www.r-project.org/")
warc_write_response(wf, "https://journal.r-project.org/archive/2016-2/RJ-2016-2.pdf")
warc_write_response(wf, "https://journal.r-project.org/RLogo.png")
close_warc_file(wf)

xdf <- read_warc("~/Desktop/test.warc.gz", include_payload = TRUE)

glimpse(xdf)

select(xdf, content_length, http_protocol_content_type)

image_read(xdf$payload[[5]])
```

![](imgs/img2.png)

### Test Results

```{r message=FALSE, warning=FALSE, error=FALSE}
library(jwatr)
library(testthat)

date()

test_dir("tests/")
```

